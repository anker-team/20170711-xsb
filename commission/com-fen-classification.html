<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>销售宝</title>    
    <link rel="stylesheet" type="text/css" href="../css/mui.min.css"/>
    <link rel="stylesheet" type="text/css" href="../css/own.css"/>
   	<link rel="stylesheet" type="text/css" href="../css/iconfont.css"/>
    <style>
			html,
			body {
				background-color: #efeff4;
			}
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				
				margin: 0;
			}
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			.mui-slider .mui-slider-group .mui-slider-item img{
				vertical-align: middle;
				width: 24px;
			}
			h5 {
			color: black
		}
		
		.month{
			float: right;
			font-weight: 500;
		}
		
		.appName{
			float: left;
			font-size: 17px;
		}
		
		.areaName{
			float: left;
		}		
		
		.status{
			float: right;
			color: red;
			font-weight: 500;
		}
		.li-padding{
			padding: 0 0 0 15px;
		}
		.mui-control-content .mui-loading {
			margin-top: 50px;
		}
		.mui-pull-left,.mui-pull-right {
			color: gray;
		}
		</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav own-main-background-color">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title" style="color: white;"></h1>
	</header>
	<div class="mui-content">
		<div id="slider" class="mui-slider mui-fullscreen">
			<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
				<div class="mui-scroll" style="width:100%" >
					<a class="mui-control-item mui-active" href="#item1mobile" style="width:33%">
						月
					</a>
					<a class="mui-control-item" href="#item2mobile" style="width:34%">
						分公司
					</a>
					<a class="mui-control-item" href="#item3mobile" style="width:33%">
						套餐
					</a>
				</div>
			</div>
			<div class="mui-slider-progress-bar mui-col-xs-4" style="border-bottom: 0;"></div>
			<div class="mui-slider-group">
				<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
					<div id="scroll1" class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view">
								<li class="mui-table-view-cell">
									<h5 class="appName">佣金总额</h5>
									<h5 class="status"></h5>
								</li>
								<li class="mui-table-view-cell" id="chart" style="height: 250px;padding: 0;">
									
								</li>
							</ul>
							<ul class="mui-table-view comlist" >
								<li class="mui-table-view-cell">
									<h5 class="appName">套餐佣金排名</h5>
								</li>
								 <!--<li class="mui-table-view-cell">
								 	<div style="width: 10%;float: left;vertical-align: middle;"><img  src="../img/yjicon_5.png"/></div>
								 	<div style="width: 90%;float: left;white-space: normal;"><p>天翼e家-双百兆全家福-169元&lt;天翼宽带+移动+高清电视+固话&gt;</p><p>dadfa</p></div>
								 	</li>-->
							</ul>
						</div>
					</div>
				</div>
				<div id="item2mobile" class="mui-slider-item mui-control-content">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll" >
							<div class="mui-loading">
								<div class="mui-spinner" >
								</div>
							</div>
							<ul class="mui-table-view" style="display: none;">
							</ul>
						</div>
					</div>
				</div>
				<div id="item3mobile" class="mui-slider-item mui-control-content">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll" id="s3">
							<div class="mui-loading">
								<div class="mui-spinner" >
								</div>
							</div>
							<ul class="mui-table-view" style="display: none;">
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script src="../js/mui.min.js" charset="UTF-8"></script>
	<script src="../js/own.js" charset="UTF-8"></script>
	<script src="../js/ajax.js" charset="UTF-8"></script>
	<script src="../js/mui.pullToRefresh.js"></script>
	<script src="../js/mui.pullToRefresh.material.js"></script>
	<script src="../js/echarts.common.min.js" charset="utf-8"></script>
	<script type="text/javascript" charset="UTF-8">
		mui.init({
			swipeBack:false			
		});
		//阻尼系数
		var deceleration = mui.os.ios?0.003:0.0009;
		mui('.mui-scroll-wrapper').scroll({
			bounce: false,
			indicators: true, //是否显示滚动条
			deceleration:deceleration
		});
		mui.ready(function() {
			//循环初始化所有下拉刷新，上拉加载。
			mui.each(document.querySelectorAll('#item3mobile .mui-scroll'), function(index, pullRefreshEl) {
				mui(pullRefreshEl).pullToRefresh({
					up: {
						callback: function() {
							var self = this;
							setTimeout(function() {
								if(pagesize>page*10){
									page++;
									ajax_get_package_commission({
										page : page,
										page_size:'10',
										appuserid:JSON.parse(localStorage.getItem('$users')).appuserid,
										month :month,
										areacode:areacode,
										busscode:busscode,
										type : type
									},function(data){ 
										if(data.code=='000000'){
											var ul = self.element.querySelector('.mui-table-view');
											ul.appendChild(createFragment(data.commList));
										};
									});
								}else{
									isnodata = true;
								}
								self.endPullUpToRefresh(isnodata);
							}, 500);
						}
					}
				});
			});
			var createFragment = function(commList) {
				var fragment = document.createDocumentFragment();
				var li;
				mui.each(commList,function(index,item){
					li = document.createElement('li');
					li.className = 'mui-table-view-cell';
					li.setAttribute('data-code',item.code);
					li.innerHTML='<h5 class="areaName">当前名次：第'+pagenum+'名</h5><h5 class="status">￥'+parseFloat(item.amount).toLocaleString()+'</h5>';
					fragment.appendChild(li);
					li = document.createElement('li');
					li.className = 'mui-table-view-cell li-padding';
					li.setAttribute('data-code',item.code);
					li.innerHTML='<table style="width: 100%"><thead><th width="30%"></th><th width="70%"></th></thead><tbody><tr style="font-size: 14px"><td style="border-right:1px solid #EEEED1">套餐编码</td><td style="border-top:0">'+item.code+'</td></tr><tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;"><td style="border-right:1px solid #EEEED1">套餐名称</td><td style="border-top:0">'+item.name+'</td></tr><tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;"><td style="border-right:1px solid #EEEED1">业务佣金(元)</td><td style="border-top:0">'+parseFloat(item.bussamount).toLocaleString()+'</td></tr><tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;"><td style="border-right:1px solid #EEEED1;">终端佣金(元)</td><td>'+parseFloat(item.pdamount).toLocaleString()+'</td></tr></tbody></table>';
					fragment.appendChild(li);
					//
					pagenum++;
				});
				return fragment;
			}
		});
		var currentWebView;//当前页面
		var	month; //查询月份
		var item2; //分公司，代理商，门店
		var item3; //套餐 
		var page =1 ;
		var pagesize = 0;
		var isnodata = false ;
		var comweblist;
		var pagenum = 1;
		var areacode="N";
		var	busscode="N";
		var	netcode="N";
		var	type="N";
		mui.plusReady(function(){
			currentWebView = plus.webview.currentWebview();
			item2= document.getElementById('item2mobile');
			item3= document.getElementById('item3mobile');
			month = currentWebView.month||'';
			type = currentWebView.type||'';
			comweblist = document.querySelector('.comlist');
			//获取标题
			document.querySelector('.mui-title').innerText = month.replace('-','年')+'月佣金总览';
			//document.querySelector('.mui-control-content').style.minHeight = (plus.screen.resolutionHeight-82)+'px';
			
			//获取图表数据
			var info ={
				appuserid:JSON.parse(localStorage.getItem('$users')).appuserid,
				month :month,
				areacode:areacode,
				busscode:busscode,
				netcode:netcode,
				type : type
			}
			ajax_get_commission_classification(info,function(data){
				if(data.code == '000000'){
					var num1 = [];
					var num2 = [];
					var heiht = 32*parseInt(data.comList.length);
					if(heiht>250)
						document.getElementById("chart").style.height = heiht+'px';
					var barChart = echarts.init(document.getElementById('chart'));
					//回写佣金总额
					document.querySelector('.status').innerText = '¥'+parseFloat(data.account).toLocaleString();
					//回写佣金分类明细图表
					mui.each(data.comList,function(index,item){
					  	num1.push(item.name);
					 	num2.push(item);
					});
					chartOption.legend.data = num1;
					chartOption.series[0].data =num2 ;
					barChart.setOption(chartOption);
					//回写前十套餐
					mui.each(JSON.parse(data.sortList),function(index,item){
						var html='';
					  	var li = document.createElement("li");
					  	li.className = 'mui-table-view-cell';
					  	html = '<div style="width: 10%;float: left;vertical-align: middle;"><img  src="../img/num_'+index+'.png"/></div>\
								<div style="width: 90%;float: left;white-space: normal;"><p>'+item.comboname+'</p>\
								<p>佣金额度(元)：'+parseFloat(item.curamount).toLocaleString()+'</p></div>';
						li.innerHTML = html;
						comweblist.appendChild(li);
					});
				}else{
					mui.alert(data.msg);
				}
				
			});
			
			document.getElementById('slider').addEventListener('slide', function(e) {
				if (e.detail.slideNumber === 1) {//分公司列表
					if (item2.querySelector('.mui-loading')) {
						ajax_get_area_commission({
							appuserid:JSON.parse(localStorage.getItem('$users')).appuserid,
							month :month,
							areacode:areacode,
							busscode:busscode,
							netcode:netcode,
							type : type
						},function(data){
							var html2 ='';
							if(data.code=='000000'){
								mui.each(data.commList,function(index,item){
									html2 += '<ul class="mui-table-view list-padding" data-code="'+item.code+'">\
											<li class="mui-table-view-cell">\
											<h5 class="areaName">'+item.name+'</h5>\
											<h5 class="status">￥'+parseFloat(item.amount).toLocaleString()+'</h5>\
											</li>\
											<li class="mui-table-view-cell" style="padding: 0 0 0 15px">\
											<table style="width: 100%">\
											<thead>\
											<th width="30%"></th>\
											<th width="70%"></th>\
											</thead><tbody>\
											<tr style="font-size: 14px">\
											<td style="border-right:1px solid #EEEED1">业务佣金(元)</td>\
											<td style="border-top:0">'+parseFloat(item.bussamount).toLocaleString()+'</td>\
											</tr>\
											<tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;">\
											<td style="border-right:1px solid #EEEED1;">终端佣金(元)</td>\
											<td>'+parseFloat(item.pdamount).toLocaleString()+'</td></tr></tbody></table></li></ul>';
								});
							}else{
								html2 ='<div style="text-align: center; margin-top: 50px;background-color:#efeff4;">\
										<span style="color: gray; font-size: 0.9em;">'+data.msg+'</span></div>';
							}
							item2.querySelector('.mui-scroll').innerHTML = html2;
							
							//'地区'监听点击事件，查看明细页面
							mui('.mui-scroll-wrapper').on('tap','.list-padding',function(){
								var code =this.getAttribute('data-code');
								mui.openWindow({
									url:'../commission/com-dl-classification.html',
									id:'../commission/com-dl-classification.html',
									styles:{
										popGesture:'close'
									},
									extras:{
										month:month,
										areacode:code
									},
									show:{
										aniShow:'pop-in'
									},
									waiting:{
										autoShow:false
									}
								});
							});
						});
					}
				}else if (e.detail.slideNumber === 2) {//套餐列表
					if(page !='1')
						return; 
					if (item3.querySelector('.mui-loading')) {
						ajax_get_package_commission({
							page : '1',
							page_size:'10',
							appuserid:JSON.parse(localStorage.getItem('$users')).appuserid,
							month :month,
							areacode:areacode,
							busscode:busscode,
							type : type
						},function(data){
							var html3 ='';
							if(data.code=='000000'){
								mui.each(data.commList,function(index,item){
									html3 +='<li class="mui-table-view-cell" data-code="'+item.code+'">\
											<h5 class="areaName">当前名次：第'+pagenum+'名</h5>\
											<h5 class="status">￥'+parseFloat(item.amount).toLocaleString()+'</h5>\
											</li>\
											<li class="mui-table-view-cell" data-code="'+item.code+'" style="padding: 0 0 0 15px">\
											<table style="width: 100%;table-layout:fixed;">\
											<thead>\
											<th width="30%"></th>\
											<th width="70%"></th>\
											</thead><tbody>\
											<tr style="font-size: 14px">\
											<td style="border-right:1px solid #EEEED1">套餐代码</td>\
											<td style="border-top:0">'+item.code+'</td>\
											</tr>\
											<tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;">\
											<td style="border-right:1px solid #EEEED1">套餐名称</td>\
											<td style="border-top:0">'+item.name+'</td>\
											</tr>\
											<tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;">\
											<td style="border-right:1px solid #EEEED1">业务佣金(元)</td>\
											<td style="border-top:0">'+parseFloat(item.bussamount).toLocaleString()+'</td>\
											</tr>\
											<tr style="font-size: 14px;border:1px solid #EEEED1;border-left: 0;">\
											<td style="border-right:1px solid #EEEED1;">终端佣金(元)</td>\
											<td>'+parseFloat(item.pdamount).toLocaleString()+'</td></tr></tbody></table></li>';
											//
											pagenum++;
								});								
								pagesize = data.pagesize;
								
							}else{
								html3 ='<div style="text-align: center; margin-top: 50px;background-color:#efeff4;">\
										<span style="color: gray; font-size: 0.9em;">未查询到相关数据</span></div>';
							}
							item3.querySelector('.mui-table-view').style.display='block';
							item3.querySelector('.mui-loading').style.display='none';
							item3.querySelector('.mui-table-view').innerHTML=html3 ;
							
						});
					}
				}
			});
			
			//'套餐'监听点击事件，查看明细页面
			mui('#item3mobile').on('tap','li',function(){
				var combocode =this.getAttribute('data-code');
				mui.openWindow({
					url:'../commission/com-menu-order.html',
					id:'../commission/com-menu-order.html',
					styles:{
						popGesture:'close'
					},
					extras:{
						combocode : combocode,
						leveltype : '1',
						level : 'item3mobile',
						month:month,
						netcode :''
					},
					show:{
						aniShow:'pop-in'
					},
					waiting:{
						autoShow:false
					}
				});
			});
			
		});
		
		
				
		//图表控件
		var	chartOption = {
		    legend: {
		        orient: 'orient',
		        x: 'right',
		        top:'middle',
		       // data:['发展佣金    335','业务受理    123,345','终端佣金    0','话费分成    0','充值缴费    0','维系佣金    0','增值发展    0']
		    	data:[]
		    },
		    series: [
		        {
		            name:'佣金明细',
		            type:'pie',
		            radius: ['30%', '50%'],
		            avoidLabelOverlap: false,
		            label: {
		                normal: {
		                    show: false,
		                    position: 'center'
		                },
		                emphasis: {
		                    show: false,
		                    textStyle: {
		                        fontSize: '16',
		                        fontWeight: 'bold'
		                    }
		                }
		            },
		            labelLine: {
		                normal: {
		                    show: false
		                }
		            },
		            center: ['24%', '50%'],
					data:[]
		        }
		    ]
		};
		
	</script>
</body>
</html>